@model List<prototipo2.Models.CarritoDTO>

@{
    ViewData["Title"] = "Pago con PayPal";
    var total = Model.Sum(x => x.Subtotal);
}

<div class="container mt-5" style="max-width: 700px;">
    <div class="card shadow border-0 rounded-3">
        <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center">
            <img src="https://www.paypalobjects.com/webstatic/icon/pp258.png" alt="PayPal" style="height: 40px;" />
            <span class="fw-bold text-primary fs-5">Confirmación de Pago</span>
        </div>
        <div class="card-body p-4">
            @if (Model != null && Model.Count > 0)
            {
                <h5 class="mb-4 fw-semibold">Resumen de Compra</h5>

                <table class="table table-borderless">
                    <thead>
                        <tr class="text-muted small">
                            <th>Producto</th>
                            <th class="text-end">Precio</th>
                            <th class="text-center">Cantidad</th>
                            <th class="text-end">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr>
                                <td class="align-middle">@item.Nombre_Producto</td>
                                <td class="align-middle text-end">₡@item.Precio.ToString("N2")</td>
                                <td class="align-middle text-center">@item.Cantidad</td>
                                <td class="align-middle text-end">₡@item.Subtotal.ToString("N2")</td>
                            </tr>
                        }
                    </tbody>
                </table>

                <hr />

                <div class="d-flex justify-content-between align-items-center mb-4">
                    <strong class="fs-5">Total a Pagar:</strong>
                    <span class="fs-4 text-primary fw-bold">₡@total.ToString("N2")</span>
                </div>

                <form id="datosVentaForm">
                    <h5 class="mb-3">Datos de Envío</h5>

                    <div class="mb-3">
                        <label class="form-label">Nombre</label>
                        <input name="contacto" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Teléfono</label>
                        <input name="telefono" class="form-control" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Dirección</label>
                        <textarea name="direccion" class="form-control" required></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Provincia</label>
                            <select name="IdProvincia" class="form-select" required>
                                <option value="1">San José</option>
                                <option value="2">Alajuela</option>
                                <option value="3">Heredia</option>
                                <option value="4">Cartago</option>
                                <option value="5">Limon</option>
                                <option value="6">Guanacaste</option>
                                <option value="7">Puntarenas</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Departamento</label>
                            <select name="IdDepartamento" class="form-select" required>
                                <option value="1">San José</option>
                                <option value="2">Alajuela</option>
                                <option value="3">Cartago</option>
                                <option value="4">Heredia</option>
                                <option value="5">Guanacaste</option>
                                <option value="6">Puntarenas</option>
                                <option value="7">Limón</option>
                            </select>
                        </div>

                        <div class="col-md-4 mb-3">
                            <label class="form-label">Distrito</label>
                            <select name="IdDistrito" class="form-select" required>
                                <option value="1">Carmen</option>
                                <option value="2">Merced</option>
                                <option value="3">Hospital</option>
                                <option value="4">Catedral</option>
                                <option value="5">Zapote</option>
                                <option value="6">San Francisco de Dos Ríos</option>
                                <option value="7">Uruca</option>
                                <option value="8">Mata Redonda</option>
                                <option value="9">Pavas</option>
                                <option value="10">Hatillo</option>
                                <option value="11">San Sebastián</option>
                            </select>
                        </div>


                    </div>

                    <div id="paypal-button-container" class="mt-4"></div>

                </form>

                <a asp-controller="Carrito" asp-action="Index" class="btn btn-link mt-3 d-block text-center text-decoration-none text-muted">
                    <i class="bi bi-arrow-left"></i> Volver al Carrito
                </a>
            }
            else
            {
                <div class="alert alert-warning text-center my-5">
                    <i class="bi bi-exclamation-triangle fs-1 mb-3"></i>
                    <h5>No hay productos para pagar.</h5>
                </div>
            }
        </div>
        <div class="card-footer text-center text-muted small bg-white">
            &copy; @DateTime.Now.Year PayPal, Inc. Todos los derechos reservados.
        </div>
    </div>
</div>

@using System.Globalization

<script src="https://www.paypal.com/sdk/js?client-id=AWcNJsABQJYbYsa1Vd8uqeDvm_rdxPIN-X_-ESNxxMle19fG2FExth5pKt29vcVtEzSHJCag4hIav9RZ&currency=USD"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        var total = "@total.ToString("F2", CultureInfo.InvariantCulture)";

        // Validar que el total sea mayor que 0
        if (parseFloat(total) <= 0) {
            alert("El total debe ser mayor que cero");
            return;
        }

        paypal.Buttons({
            style: {
                layout: 'vertical',
                color: 'blue',
                shape: 'rect',
                label: 'paypal'
            },
            createOrder: function (data, actions) {
                // Validar formulario antes de proceder
                const form = document.getElementById('datosVentaForm');
                if (!form.checkValidity()) {
                    alert("Por favor complete todos los campos requeridos");
                    return false;
                }

                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: total,
                            currency_code: 'USD' 
                        }
                    }]
                });
            },
            onApprove: function (data, actions) {
                return actions.order.capture().then(function (details) {
                    const form = document.getElementById('datosVentaForm');
                    const formData = new FormData(form);

                    const info = {
                        orderId: data.orderID,
                        payerId: data.payerID,
                        total: total,
                        contacto: formData.get('contacto'),
                        telefono: formData.get('telefono'),
                        direccion: formData.get('direccion'),
                        IdProvincia: formData.get('IdProvincia'),
                        IdDepartamento: formData.get('IdDepartamento'),
                        IdDistrito: formData.get('IdDistrito')
                    };

                    return fetch('@Url.Action("ConfirmarPago", "Carrito")', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        },
                        body: JSON.stringify(info)
                    })
                        .then(res => {
                            if (!res.ok) {
                                throw new Error('Error en la red');
                            }
                            return res.json();
                        })
                        .then(res => {
                            if (res.success) {
                                window.location = '@Url.Action("Gracias", "Carrito")';
                            } else {
                                alert("Error al procesar la venta: " + (res.error || "Error desconocido"));
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert("Error de red: " + error.message);
                        });
                });
            },
            onError: function (err) {
                console.error('PayPal Error:', err);
                alert("Ocurrió un error con PayPal: " + err.toString());
            },
            onClick: function () {
                // Validar formulario al hacer clic
                const form = document.getElementById('datosVentaForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return false;
                }
                return true;
            }
        }).render('#paypal-button-container');
    });
</script>


<style>
    body {
        background-color: #f6f9fc;
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    }
</style>
